###
# Forgot Password Flow - Testing Script
# Use this file with Visual Studio REST Client or similar tools
###

@baseUrl = https://localhost:7162
@contentType = application/json

###
# Step 1A: Verify Identity with Emirates ID
# When using Emirates ID, Mobile Number is required (Email is optional)
# Format: XXX-YYYY-NNNNNNN-C (3 digits - 4 digits - 7 digits - 1 digit)
###
POST {{baseUrl}}/api/authentication/forgot-password/verify-identity
Content-Type: {{contentType}}

{
  "MRNO": "MRN123456",
  "EmiratesId": "112-2334-4556677-8",
  "MobileNumber": "+971501234567",
  "DateOfBirth": "1990-01-15"
}

### Expected Response:
# {
#   "isVerified": true,
#   "verificationToken": "base64_encoded_token_here",
#   "message": "Identity verified successfully. You can now set your new password."
# }

###
# Step 1B: Verify Identity with Passport Number
# When using Passport, Email is required (Mobile Number is optional)
###
POST {{baseUrl}}/api/authentication/forgot-password/verify-identity
Content-Type: {{contentType}}

{
  "MRNO": "MRN789012",
  "PassportNumber": "A12345678",
  "Email": "patient@example.com",
  "DateOfBirth": "1990-01-15"
}

### Expected Response:
# {
#   "isVerified": true,
#   "verificationToken": "base64_encoded_token_here",
#   "message": "Identity verified successfully. You can now set your new password."
# }

###
# Step 2: Set New Password
# Replace verificationToken with the token received from Step 1
###
POST {{baseUrl}}/api/authentication/forgot-password/set-new-password
Content-Type: {{contentType}}

{
  "verificationToken": "PASTE_TOKEN_FROM_STEP_1_HERE",
  "password": "NewSecureP@ss123",
  "confirmPassword": "NewSecureP@ss123"
}

### Expected Response:
# {
#   "success": true,
#   "message": "Password updated successfully. Please login with your new password."
# }

###
# Test Login with New Password
###
POST {{baseUrl}}/api/authentication/login
Content-Type: {{contentType}}

{
  "identifier": "MRN123456",
  "password": "NewSecureP@ss123"
}

### Expected Response:
# {
#   "success": true,
#   "accessToken": "jwt_token_here",
#   "refreshToken": "refresh_token_here",
#   "expiresIn": 3600,
#   "patient": { ... }
# }

###
# ERROR TEST 1: Invalid Information
###
POST {{baseUrl}}/api/authentication/forgot-password/verify-identity
Content-Type: {{contentType}}

{
  "MRNO": "INVALID_MRN",
  "EmiratesId": "784-0000-0000000-0",
  "Email": "wrong@example.com",
  "MobileNumber": "+971500000000",
  "DateOfBirth": "2000-01-01"
}

### Expected Response:
# {
#   "isVerified": false,
#   "message": "Invalid information provided. Please check your details and try again."
# }

###
# ERROR TEST 2: Weak Password
###
POST {{baseUrl}}/api/authentication/forgot-password/set-new-password
Content-Type: {{contentType}}

{
  "verificationToken": "VALID_TOKEN",
  "password": "weak",
  "confirmPassword": "weak"
}

### Expected Response:
# {
#   "type": "https://tools.ietf.org/html/rfc7231#section-6.5.1",
#   "title": "One or more validation errors occurred.",
#   "status": 400,
#   "errors": {
#     "Password": [
#       "Password must be at least 8 characters",
#       "Password must contain at least one uppercase letter (A-Z)",
#       ...
#     ]
#   }
# }

###
# ERROR TEST 3: Password Mismatch
###
POST {{baseUrl}}/api/authentication/forgot-password/set-new-password
Content-Type: {{contentType}}

{
  "verificationToken": "VALID_TOKEN",
  "password": "NewSecureP@ss123",
  "confirmPassword": "DifferentPassword123!"
}

### Expected Response:
# {
#   "errors": {
#     "ConfirmPassword": ["Passwords do not match"]
#   }
# }

###
# ERROR TEST 4: Invalid Verification Token
###
POST {{baseUrl}}/api/authentication/forgot-password/set-new-password
Content-Type: {{contentType}}

{
  "verificationToken": "INVALID_OR_EXPIRED_TOKEN",
  "password": "NewSecureP@ss123",
  "confirmPassword": "NewSecureP@ss123"
}

### Expected Response:
# {
#   "success": false,
#   "message": "Invalid or expired verification token. Please start the process again."
# }

###
# VALIDATION TEST 1: Missing Emirates ID and Passport
###
POST {{baseUrl}}/api/authentication/forgot-password/verify-identity
Content-Type: {{contentType}}

{
  "MRNO": "MRN123456",
  "DateOfBirth": "1990-01-15"
}

### Expected Response:
# {
#   "errors": {
#     "": ["Either Emirates ID or Passport Number is required"]
#   }
# }

###
# VALIDATION TEST 2: Emirates ID provided but Mobile Number missing
###
POST {{baseUrl}}/api/authentication/forgot-password/verify-identity
Content-Type: {{contentType}}

{
  "MRNO": "MRN123456",
  "EmiratesId": "112-2334-4556677-8",
  "DateOfBirth": "1990-01-15"
}

### Expected Response:
# {
#   "errors": {
#     "MobileNumber": ["Mobile number is required when using Emirates ID"]
#   }
# }

###
# VALIDATION TEST 3: Passport provided but Email missing
###
POST {{baseUrl}}/api/authentication/forgot-password/verify-identity
Content-Type: {{contentType}}

{
  "MRNO": "MRN123456",
  "PassportNumber": "A12345678",
  "DateOfBirth": "1990-01-15"
}

### Expected Response:
# {
#   "errors": {
#     "Email": ["Email is required when using Passport Number"]
#   }
# }

###
# VALIDATION TEST: Invalid Email Format
###
POST {{baseUrl}}/api/authentication/forgot-password/verify-identity
Content-Type: {{contentType}}

{
  "MRNO": "MRN123456",
  "EmiratesId": "112-2334-4556677-8",
  "Email": "not-an-email",
  "MobileNumber": "+971501234567",
  "DateOfBirth": "1990-01-15"
}

### Expected Response:
# {
#   "errors": {
#     "Email": ["Invalid email format"]
#   }
# }

###
# VALIDATION TEST: Invalid Date Format
###
POST {{baseUrl}}/api/authentication/forgot-password/verify-identity
Content-Type: {{contentType}}

{
  "MRNO": "MRN123456",
  "EmiratesId": "112-2334-4556677-8",
  "Email": "patient@example.com",
  "MobileNumber": "+971501234567",
  "DateOfBirth": "15/01/1990"
}

### Expected Response:
# {
#   "errors": {
#     "DateOfBirth": ["Date of birth must be in format: yyyy-MM-dd"]
#   }
# }
